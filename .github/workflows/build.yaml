name: Build
on:
  push:
    branches: ["main"]
    tags: ["v*"]
  pull_request:
  workflow_dispatch:

jobs:
  build-linux:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4

      - name: Install Qt
        uses: jurplel/install-qt-action@v4
        with:
          version: "6.8.0"
          target: "desktop"
          modules: "qtwebengine qtwebchannel qtpositioning"
          cache: true

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libgl1-mesa-dev libxkbcommon-x11-0 libxcb-cursor0 fuse libfuse2 libnss3 libdbus-1-3 libxcomposite1 libxrender1 libxrandr2 libxtst6 libxi6 libasound2 libegl1-mesa-dev

      - name: Build
        run: |
          cmake -B build -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX=/usr
          cmake --build build -j$(nproc)

      - name: Package AppImage
        run: |
          cd build
          DESTDIR=./AppDir cmake --install .

          cp ../assets/icons/logo.png ./AppDir/dev.arnv.nicol.png
          mkdir -p ./AppDir/usr/share/icons
          cp ../assets/icons/logo.png ./AppDir/usr/share/icons/dev.arnv.nicol.png

          wget -q "https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-x86_64.AppImage" -O linuxdeploy
          wget -q "https://github.com/linuxdeploy/linuxdeploy-plugin-qt/releases/download/continuous/linuxdeploy-plugin-qt-x86_64.AppImage" -O linuxdeploy-plugin-qt
          chmod +x linuxdeploy linuxdeploy-plugin-qt

          export QML_SOURCES_PATHS="${{ github.workspace }}"
          ./linuxdeploy --appdir AppDir --plugin qt --output appimage

          mv *.AppImage Nicol-Browser-Linux.AppImage

      - uses: actions/upload-artifact@v4
        with:
          name: Nicol-Browser-Linux.AppImage
          path: build/Nicol-Browser-Linux.AppImage
          compression-level: 0

  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Qt
        uses: jurplel/install-qt-action@v4
        with:
          version: "6.8.0"
          arch: "win64_msvc2022_64"
          modules: "qtwebengine qtwebchannel qtpositioning"

      - uses: ilammy/msvc-dev-cmd@v1

      - name: Build
        run: |
          cmake -B build -DCMAKE_BUILD_TYPE=Release
          cmake --build build --config Release --parallel

      - name: Package
        shell: pwsh
        run: |
          cmake --install build --config Release --prefix install_dir
          windeployqt --release --compiler-runtime --qmldir . install_dir\bin\appnicol.exe
          Copy-Item assets\icons\logo.png install_dir\bin\

      - name: Create Installer
        run: |
          choco install nsis -y
          cd build && cpack -G NSIS -C Release

      - uses: actions/upload-artifact@v4
        with:
          name: Nicol-Browser-Windows-Installer
          path: build/*.exe
          compression-level: 0

      - uses: actions/upload-artifact@v4
        with:
          name: Nicol-Browser-Windows-Portable
          path: install_dir

  build-macos:
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4

      - name: Install Qt
        uses: jurplel/install-qt-action@v4
        with:
          version: "6.8.0"
          modules: "qtwebengine qtwebchannel qtpositioning"

      - name: Build
        run: |
          cmake -B build -DCMAKE_BUILD_TYPE=Release
          cmake --build build --config Release --parallel

      - name: Package DMG
        run: |
          cp config.ini build/appnicol.app/Contents/MacOS/
          macdeployqt build/appnicol.app -dmg -qmldir=.

      - uses: actions/upload-artifact@v4
        with:
          name: Nicol-Browser-macOS
          path: build/*.dmg
          compression-level: 0

  release:
    if: startsWith(github.ref, 'refs/tags/v')
    needs: [build-linux, build-windows, build-macos]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare Release Files
        run: |
          mkdir release
          cp artifacts/Nicol-Browser-Linux.AppImage/* release/
          cp artifacts/Nicol-Browser-Windows-Installer/* release/
          cp artifacts/Nicol-Browser-macOS/* release/
          cd artifacts/Nicol-Browser-Windows-Portable && zip -r ../../release/Nicol-Browser-Windows-Portable.zip .

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: release/*
          generate_release_notes: true
          draft: false
