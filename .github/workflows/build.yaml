name: Build
on:
  push:
    branches: ["main"]
    tags: ["v*"]
  pull_request:
  workflow_dispatch:

jobs:
  build-linux:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4

      - name: Install Qt
        uses: jurplel/install-qt-action@v4
        with:
          version: "6.8.0"
          target: "desktop"
          modules: "qtwebengine qtwebchannel qtpositioning qtserialport"
          cache: true
          tools: "tools_cmake"

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libgl1-mesa-dev libxkbcommon-x11-0 libxcb-icccm4 libxcb-image0 libxcb-keysyms1 libxcb-render-util0 libxcb-xinerama0 libxcb-randr0 libxcb-shape0 libxcb-sync1 libxcb-xfixes0 libxcb-xinput0 libzstd-dev libvulkan-dev libxcb-cursor0 fuse libfuse2 libnss3 libdbus-1-3 libxcomposite1 libxrender1 libxrandr2 libxtst6 libxi6 libasound2 libegl1-mesa-dev fontconfig libxcursor1 libxdamage1 libxss1 libpci3

      - name: Debug Qt paths
        run: |
          echo "QT_ROOT_DIR: ${QT_ROOT_DIR}"
          echo "Qt6_DIR: ${Qt6_DIR}"
          echo "=== Root directory ==="
          ls -la "${QT_ROOT_DIR}/" || true
          echo "=== QML directory ==="
          ls -la "${QT_ROOT_DIR}/qml/" 2>/dev/null || echo "No qml/ directory at QT_ROOT_DIR"
          echo "=== Looking for QtWebEngine ==="
          find "${QT_ROOT_DIR}" -name "*WebEngine*" -type d 2>/dev/null | head -20 || true
          echo "=== Looking for QtWebEngineProcess ==="
          find "${QT_ROOT_DIR}" -name "QtWebEngineProcess" 2>/dev/null || true
          echo "=== Looking for resources ==="
          find "${QT_ROOT_DIR}" -name "qtwebengine_resources.pak" 2>/dev/null || true

      - name: Build
        run: |
          cmake -B build -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX=/usr
          cmake --build build -j$(nproc)

      - name: Package AppImage
        run: |
          cd build
          DESTDIR=./AppDir cmake --install .

          cp ../assets/icons/logo.png ./AppDir/dev.arnv.nicol.png
          mkdir -p ./AppDir/usr/share/icons
          cp ../assets/icons/logo.png ./AppDir/usr/share/icons/dev.arnv.nicol.png

          wget -q "https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-x86_64.AppImage" -O linuxdeploy
          wget -q "https://github.com/linuxdeploy/linuxdeploy-plugin-qt/releases/download/continuous/linuxdeploy-plugin-qt-x86_64.AppImage" -O linuxdeploy-plugin-qt
          chmod +x linuxdeploy linuxdeploy-plugin-qt

          # Find Qt installation base
          QT_BASE="${QT_ROOT_DIR}"
          echo "Using QT_BASE: ${QT_BASE}"

          # Copy ALL QML modules from Qt installation
          mkdir -p ./AppDir/usr/qml
          if [ -d "${QT_BASE}/qml" ]; then
            echo "Copying entire QML directory"
            cp -r "${QT_BASE}/qml/"* ./AppDir/usr/qml/
          fi

          # Copy WebEngine resources (icudtl.dat, qtwebengine_resources.pak, etc.)
          mkdir -p ./AppDir/usr/resources
          if [ -d "${QT_BASE}/resources" ]; then
            echo "Copying resources from ${QT_BASE}/resources/"
            cp -r "${QT_BASE}/resources/"* ./AppDir/usr/resources/
          fi

          # Copy WebEngine translations
          mkdir -p ./AppDir/usr/translations/qtwebengine_locales
          if [ -d "${QT_BASE}/translations/qtwebengine_locales" ]; then
            echo "Copying translations"
            cp -r "${QT_BASE}/translations/qtwebengine_locales/"* ./AppDir/usr/translations/qtwebengine_locales/
          fi

          # Copy QtWebEngineProcess helper binary
          mkdir -p ./AppDir/usr/libexec
          if [ -f "${QT_BASE}/libexec/QtWebEngineProcess" ]; then
            echo "Copying QtWebEngineProcess"
            cp "${QT_BASE}/libexec/QtWebEngineProcess" ./AppDir/usr/libexec/
          fi

          # Debug: Check what we copied
          echo "=== Copied QML modules ==="
          ls -la ./AppDir/usr/qml/ || true
          ls -la ./AppDir/usr/qml/QtWebEngine/ 2>/dev/null || echo "No QtWebEngine QML"
          echo "=== Copied resources ==="
          ls -la ./AppDir/usr/resources/ || true

          # Create custom AppRun wrapper script (linuxdeploy-plugin-qt skips this for Qt6)
          # Write to current directory first to avoid path issues
          cat > ./custom-apprun.sh << 'APPRUNEOF'
          #!/bin/bash
          SELF=$(readlink -f "$0")
          HERE=${SELF%/*}
          export PATH="${HERE}/usr/bin:${PATH}"
          export LD_LIBRARY_PATH="${HERE}/usr/lib:${LD_LIBRARY_PATH}"
          export QT_PLUGIN_PATH="${HERE}/usr/plugins"
          export QML2_IMPORT_PATH="${HERE}/usr/qml"
          export QML_IMPORT_PATH="${HERE}/usr/qml"
          export QTWEBENGINEPROCESS_PATH="${HERE}/usr/libexec/QtWebEngineProcess"
          export QTWEBENGINE_RESOURCES_PATH="${HERE}/usr/resources"
          export QTWEBENGINE_LOCALES_PATH="${HERE}/usr/translations/qtwebengine_locales"
          export QT_QPA_PLATFORM_PLUGIN_PATH="${HERE}/usr/plugins/platforms"
          if [ -z "$QT_QPA_PLATFORM" ]; then
            if [ -n "$WAYLAND_DISPLAY" ] && [ -f "${HERE}/usr/plugins/platforms/libqwayland-generic.so" ]; then
              export QT_QPA_PLATFORM=wayland
            else
              export QT_QPA_PLATFORM=xcb
            fi
          fi
          exec "${HERE}/usr/bin/appnicol" "$@"
          APPRUNEOF
          # Remove leading whitespace from heredoc and make executable
          sed -i 's/^          //' ./custom-apprun.sh
          chmod +x ./custom-apprun.sh
          echo "=== Custom AppRun script ==="
          cat ./custom-apprun.sh

          # linuxdeploy-plugin-qt environment variables
          export QML_SOURCES_PATHS="${{ github.workspace }}"
          export EXTRA_QT_PLUGINS="wayland-shell-integration;wayland-graphics-integration-client;wayland-decoration-client;platforms"
          export QMAKE="${QT_BASE}/bin/qmake"
          export LD_LIBRARY_PATH="${QT_BASE}/lib:${LD_LIBRARY_PATH}"
          export DEPLOY_PLATFORM_PLUGINS="1"
          export NO_STRIP=1

          # Run linuxdeploy to bundle libs (it will use our custom AppRun)
          ./linuxdeploy --appdir AppDir --plugin qt --custom-apprun=./custom-apprun.sh --output appimage

          # Verify QML modules were bundled
          echo "=== Checking bundled QML after linuxdeploy ==="
          ls -la ./AppDir/usr/qml/QtWebEngine/ 2>/dev/null || echo "WARNING: QtWebEngine QML still missing!"

          # Check the plugins dir
          echo "=== Checking platform plugins ==="
          ls -la ./AppDir/usr/plugins/platforms/ 2>/dev/null || echo "No platform plugins"

          # Debug: Show final AppRun
          echo "=== Final AppRun content ==="
          cat ./AppDir/AppRun

          mv *.AppImage Nicol-Browser-Linux.AppImage

      - uses: actions/upload-artifact@v4
        with:
          name: Nicol-Browser-Linux.AppImage
          path: build/Nicol-Browser-Linux.AppImage
          compression-level: 0

  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Qt
        uses: jurplel/install-qt-action@v4
        with:
          version: "6.8.0"
          arch: "win64_msvc2022_64"
          modules: "qtwebengine qtwebchannel qtpositioning qtserialport"

      - uses: ilammy/msvc-dev-cmd@v1

      - name: Build
        run: |
          cmake -B build -DCMAKE_BUILD_TYPE=Release
          cmake --build build --config Release --parallel

      - name: Package
        shell: pwsh
        run: |
          cmake --install build --config Release --prefix install_dir
          windeployqt --release --compiler-runtime --qmldir . install_dir\bin\appnicol.exe
          Copy-Item assets\icons\logo.png install_dir\bin\

      - name: Create Installer
        run: |
          choco install nsis -y
          cd build && cpack -G NSIS -C Release

      - uses: actions/upload-artifact@v4
        with:
          name: Nicol-Browser-Windows-Installer
          path: build/*.exe
          compression-level: 0

      - uses: actions/upload-artifact@v4
        with:
          name: Nicol-Browser-Windows-Portable
          path: install_dir

  build-macos:
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4

      - name: Install Qt
        uses: jurplel/install-qt-action@v4
        with:
          version: "6.8.0"
          modules: "qtwebengine qtwebchannel qtpositioning qtserialport"

      - name: Build
        run: |
          cmake -B build -DCMAKE_BUILD_TYPE=Release
          cmake --build build --config Release --parallel

      - name: Package DMG
        run: |
          cp config.ini build/appnicol.app/Contents/MacOS/
          macdeployqt build/appnicol.app -dmg -qmldir=.

      - uses: actions/upload-artifact@v4
        with:
          name: Nicol-Browser-macOS
          path: build/*.dmg
          compression-level: 0

  release:
    if: startsWith(github.ref, 'refs/tags/v')
    needs: [build-linux, build-windows, build-macos]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare Release Files
        run: |
          mkdir release
          cp artifacts/Nicol-Browser-Linux.AppImage/* release/
          cp artifacts/Nicol-Browser-Windows-Installer/* release/
          cp artifacts/Nicol-Browser-macOS/* release/
          cd artifacts/Nicol-Browser-Windows-Portable && zip -r ../../release/Nicol-Browser-Windows-Portable.zip .

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: release/*
          generate_release_notes: true
          draft: false
