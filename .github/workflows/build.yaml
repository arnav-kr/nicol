name: Build
on:
  push:
    branches: ["main"]
  pull_request:
  workflow_dispatch:

jobs:
  build-linux:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Qt
        uses: jurplel/install-qt-action@v4
        with:
          version: "6.8.0"
          modules: "qtwebengine qtwebchannel qtpositioning qtserialport"
          host: "linux"
          cache: "true"

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libgl1-mesa-dev libxkbcommon-x11-0 libxcb-icccm4 libxcb-image0 libxcb-keysyms1 libxcb-render-util0 libxcb-xinerama0 libxcb-randr0 libxcb-shape0 libxcb-sync1 libxcb-xfixes0 libxcb-xinput0 libzstd-dev libvulkan-dev libxcb-cursor0 fuse libfuse2

      - name: Install WebEngine dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libnss3 libdbus-1-3 libxcomposite1 libxrender1 libxrandr2 libxtst6 libxi6 libasound2 libegl1-mesa-dev libgl1-mesa-dev libxkbcommon-x11-0 fontconfig libxcursor1 libxdamage1 libxss1 libpci3

      - name: Build
        run: |
          mkdir build && cd build
          cmake .. -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX=/usr
          cmake --build . -j$(nproc)

      - name: Package AppImage
        run: |
          cd build
          DESTDIR=./AppDir cmake --install .

          # Ensure icon is in place
          cp ../assets/icons/logo.png ./AppDir/dev.arnv.nicol.png
          mkdir -p ./AppDir/usr/share/icons
          cp ../assets/icons/logo.png ./AppDir/usr/share/icons/dev.arnv.nicol.png

          # Download linuxdeploy (better Qt6 support than linuxdeployqt)
          wget -c -nv "https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-x86_64.AppImage" -O linuxdeploy
          wget -c -nv "https://github.com/linuxdeploy/linuxdeploy-plugin-qt/releases/download/continuous/linuxdeploy-plugin-qt-x86_64.AppImage" -O linuxdeploy-plugin-qt
          chmod +x linuxdeploy linuxdeploy-plugin-qt

          # Set environment for Qt plugin
          export QML_SOURCES_PATHS="${{ github.workspace }}"
          export EXTRA_QT_PLUGINS="webenginecore;webengine;webenginewidgets"

          # Run linuxdeploy with Qt plugin
          ./linuxdeploy --appdir AppDir --plugin qt --output appimage

          # Rename output
          mv *.AppImage Nicol-Browser-Linux.AppImage

      - name: Upload Linux Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Nicol-Browser-Linux.AppImage
          path: build/Nicol-Browser-Linux.AppImage
  build-windows:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Qt
        uses: jurplel/install-qt-action@v4
        with:
          version: "6.8.0"
          host: "windows"
          arch: "win64_msvc2022_64"
          modules: "qtwebengine qtwebchannel qtpositioning qtserialport"

      - name: Setup MSVC
        uses: ilammy/msvc-dev-cmd@v1

      - name: Configure CMake
        run: cmake -B build -DCMAKE_BUILD_TYPE=Release

      - name: Build
        run: cmake --build build --config Release --parallel

      - name: Install NSIS
        run: choco install nsis -y

      - name: Install and Package
        shell: pwsh
        run: |
          # Install to staging directory
          cmake --install build --config Release --prefix install_dir

          # Run windeployqt on installed executable
          windeployqt --release --compiler-runtime --qmldir . install_dir\bin\appnicol.exe

          # Copy assets
          Copy-Item assets\icons\logo.png install_dir\bin\

      - name: Create Installer
        shell: pwsh
        run: |
          cd build
          cpack -G NSIS -C Release

      - name: Upload Windows Installer
        uses: actions/upload-artifact@v4
        with:
          name: Nicol-Browser-Windows-Installer
          path: build/*.exe

      - name: Upload Windows Portable
        uses: actions/upload-artifact@v4
        with:
          name: Nicol-Browser-Windows-Portable
          path: install_dir
  build-macos:
    runs-on: macos-14
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Qt
        uses: jurplel/install-qt-action@v4
        with:
          version: "6.8.0"
          host: "mac"
          arch: "clang_64"
          modules: "qtwebengine qtwebchannel qtpositioning qtserialport"

      - name: Configure CMake
        run: cmake -B build -DCMAKE_BUILD_TYPE=Release

      - name: Build
        run: cmake --build build --config Release --parallel

      - name: Deploy and Package (DMG)
        run: |
          # Copy config.ini into app bundle
          cp config.ini build/appnicol.app/Contents/MacOS/

          # Run macdeployqt
          macdeployqt build/appnicol.app -dmg -qmldir=. -verbose=1

      - name: Upload macOS Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Nicol-Browser-macOS
          path: build/*.dmg
